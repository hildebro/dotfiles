#!/bin/bash

# A script to download a song from Spotify, move it to a web server, and clean up.

# Exit immediately if a command exits with a non-zero status.
set -e

# --- Configuration ---
# Your local development directory for spotdl
SPOTDL_VENV_DIR="$HOME/development/ytdlp-venv"

# The SSH user and hostname of your web server
SSH_TARGET="webserver"

# The base directory on the web server for your music files
REMOTE_MUSIC_DIR="/srv/files/Music"

# --- Main Script ---

# Check if an argument was provided
if [ -z "$1" ]; then
    echo "Usage: $0 <spotify_url_or_query>"
    exit 1
fi

echo "--- Starting download and transfer process ---"

echo "1. Changing to virtual environment directory and activating..."
cd "$SPOTDL_VENV_DIR"
source bin/activate

echo "2. Downloading song: '$1'..."
spotdl download "$1" --output '{track-number} {artist} {title}' --overwrite skip

if ! compgen -G "*.mp3" > /dev/null; then
    echo "Error: No MP3 files were downloaded. Exiting."
    exit 1
fi

echo "3. Extracting artist and album metadata..."
# Grab the first mp3 file found in the current directory
MP3_FILE=$(find . -maxdepth 1 -name "*.mp3" -print -quit)

# Use ffprobe to get metadata
# Note: You need ffprobe installed (`pacman -S ffmpeg`)
# We escape single quotes within the sed command to ensure the JSON is correctly parsed.
METADATA_JSON=$(ffprobe -v quiet -print_format json -show_format -show_streams "$MP3_FILE")
ARTIST=$(echo "$METADATA_JSON" | grep -oP '"artist": "\K[^"]*')
ALBUM=$(echo "$METADATA_JSON" | grep -oP '"album": "\K[^"]*')

if [ -z "$ARTIST" ] || [ -z "$ALBUM" ]; then
    echo "Warning: Could not extract artist or album metadata. Exiting."
    deactivate
    exit 1
fi

echo "   - Artist: $ARTIST"
echo "   - Album:  $ALBUM"

echo "4. Checking for remote directory and creating if it doesn't exist..."
# Create the full remote path. We use sed to handle any single quotes in the artist/album names.
REMOTE_DIR="${REMOTE_MUSIC_DIR}/$(echo "$ARTIST" | sed "s/'/\\\'/g")/$(echo "$ALBUM" | sed "s/'/\\\'/g")"
ssh "$SSH_TARGET" "mkdir -p \"$REMOTE_DIR\""

echo "5. Transferring files to $SSH_TARGET:$REMOTE_DIR..."
scp *.mp3 "$SSH_TARGET:$REMOTE_DIR/"

echo "6. Deactivating virtual environment and removing local mp3 files..."
deactivate
rm -v *.mp3

echo "--- Process complete! ---"
